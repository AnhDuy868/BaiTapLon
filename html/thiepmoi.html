<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Bán Thiệp Trực Tuyến</title>
    <!-- Bootstrap 5 CSS -->
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">ThiệpOnline</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="#home">Trang Chủ</a></li>
                    <li class="nav-item"><a class="nav-link" href="#products">Sản Phẩm</a></li>
                    <li class="nav-item"><a class="nav-link" href="#contact">Liên Hệ</a></li>
                </ul>
                <div class="d-flex align-items-center gap-3">
                    <span id="userInfo" class="text-success fw-bold"></span>
                    <button class="btn btn-outline-primary" id="authBtn">Đăng Nhập</button>
                    <button class="btn btn-outline-primary position-relative" id="cartBtn">
                        Giỏ Hàng <span id="cartCount" class="cart-count">0</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Các phần cũ giữ nguyên: Carousel, Products, Contact... -->
    <!-- (Giữ nguyên toàn bộ phần từ <section id="home"> đến </section> của Contact như cũ) -->

    <!-- Modal Đăng ký / Đăng nhập -->
    <div class="modal fade" id="authModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="authModalTitle">Đăng Nhập</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="authForm">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="authEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mật khẩu</label>
                            <input type="password" class="form-control" id="authPassword" required>
                        </div>
                        <div id="confirmPasswordGroup" class="mb-3" style="display:none;">
                            <label class="form-label">Nhập lại mật khẩu</label>
                            <input type="password" class="form-control" id="authConfirmPassword">
                        </div>
                        <button type="submit" class="btn btn-primary" id="authSubmit">Đăng Nhập</button>
                    </form>
                    <div class="mt-3 text-center">
                        <small>Bạn chưa có tài khoản? <a href="#" id="switchToRegister">Đăng ký ngay</a></small>
                        <br>
                        <small id="backToLogin" style="display:none;"><a href="#">Quay lại đăng nhập</a></small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Thanh toán -->
    <div class="modal fade" id="checkoutModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thanh Toán</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>Thông tin đơn hàng</h6>
                    <ul id="checkoutItems" class="list-group mb-4"></ul>
                    <p class="fw-bold">Tổng tiền: <span id="checkoutTotal">0</span> VND</p>

                    <h6>Phương thức thanh toán</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="cod" checked>
                        <label class="form-check-label" for="cod">Thanh toán khi nhận hàng (COD)</label>
                    </div>
                    <div class="form-check mb-4">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="bank" value="bank">
                        <label class="form-check-label" for="bank">Chuyển khoản ngân hàng</label>
                    </div>

                    <div id="bankInfo" style="display:none;" class="alert alert-info">
                        <strong>Thông tin chuyển khoản:</strong><br>
                        Ngân hàng: Vietcombank<br>
                        Chủ tài khoản: NGUYEN VAN A<br>
                        Số tài khoản: 1234567890<br>
                        Nội dung: [Họ tên] + [Số điện thoại]
                    </div>

                    <form id="checkoutForm">
                        <div class="mb-3">
                            <label>Họ và tên</label>
                            <input type="text" class="form-control" id="checkoutName" required>
                        </div>
                        <div class="mb-3">
                            <label>Số điện thoại</label>
                            <input type="tel" class="form-control" id="checkoutPhone" required>
                        </div>
                        <div class="mb-3">
                            <label>Địa chỉ giao hàng</label>
                            <textarea class="form-control" id="checkoutAddress" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-success" id="confirmCheckout">Xác Nhận Đơn Hàng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Các modal cũ: productModal, cartModal vẫn giữ nguyên (copy từ code cũ) -->
    <!-- ... (giữ nguyên modal sản phẩm và giỏ hàng như bạn đã có) ... -->

    <!-- Bootstrap JS, Popper, jQuery -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // ====================== DỮ LIỆU & BIẾN ======================
        const products = [ /* giữ nguyên mảng products như cũ */ 
            { id: 1, title: 'Thiệp Sinh Nhật Vui Vẻ', description: 'Thiệp sinh nhật với thiết kế rực rỡ.', price: 50000, img: '../img/sinhnhat1.png', category: 'birthday' },
            { id: 2, title: 'Thiệp Sinh Nhật Dễ Thương', price: 55000, img: '../img/sinhnhat2.webp', category: 'birthday' },
            { id: 3, title: 'Thiệp Giáng Sinh Tuyết', price: 60000, img: '../img/giangsinh.png', category: 'christmas' },
            { id: 4, title: 'Thiệp Giáng Sinh Cây Thông', price: 65000, img: '../img/caythong.png', category: 'christmas' },
            { id: 5, title: 'Thiệp Valentine Lãng Mạn', price: 70000, img: '../img/langman.png', category: 'valentine' },
            { id: 6, title: 'Thiệp Valentine Trái Tim', price: 75000, img: '../img/traitim.png', category: 'valentine' },
            { id: 7, title: 'Thiệp Năm Mới May Mắn', price: 55000, img: '../img/mayman.png', category: 'newyear' },
            { id: 8, title: 'Thiệp Năm Mới Pháo Hoa', price: 60000, img: '../img/phaohoa.png', category: 'newyear' }
        ];

        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        const itemsPerPage = 4;
        let currentPage = 1;
        let currentCategory = 'all';

        // ====================== HÀM CƠ BẢN ======================
        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
        }

        function updateCartCount() {
            $('#cartCount').text(cart.length);
        }

        function updateAuthUI() {
            if (currentUser) {
                $('#userInfo').text(`Xin chào, ${currentUser.name}`);
                $('#authBtn').text('Đăng xuất').removeClass('btn-outline-primary').addClass('btn-outline-danger');
            } else {
                $('#userInfo').text('');
                $('#authBtn').text('Đăng Nhập').removeClass('btn-outline-danger').addClass('btn-outline-primary');
            }
        }

        // ====================== ĐĂNG KÝ / ĐĂNG NHẬP ======================
        $('#authBtn').click(function () {
            if (currentUser) {
                if (confirm('Bạn có chắc muốn đăng xuất?')) {
                    currentUser = null;
                    localStorage.removeItem('currentUser');
                    updateAuthUI();
                }
            } else {
                $('#authModal').modal('show');
            }
        });

        $('#switchToRegister').click(function (e) {
            e.preventDefault();
            $('#authModalTitle').text('Đăng Ký');
            $('#authSubmit').text('Đăng Ký');
            $('#confirmPasswordGroup').show();
            $('#switchToRegister').parent().hide();
            $('#backToLogin').show();
        });

        $('#backToLogin a').click(function (e) {
            e.preventDefault();
            $('#authModalTitle').text('Đăng Nhập');
            $('#authSubmit').text('Đăng Nhập');
            $('#confirmPasswordGroup').hide();
            $('#switchToRegister').parent().show();
            $('#backToLogin').hide();
        });

        $('#authForm').submit(function (e) {
            e.preventDefault();
            const email = $('#authEmail').val().trim();
            const password = $('#authPassword').val();
            const isRegister = $('#authSubmit').text() === 'Đăng Ký';

            if (isRegister) {
                const confirmPass = $('#authConfirmPassword').val();
                if (password !== confirmPass) {
                    alert('Mật khẩu nhập lại không khớp!');
                    return;
                }
                // Lưu tài khoản mới
                const users = JSON.parse(localStorage.getItem('users')) || [];
                if (users.find(u => u.email === email)) {
                    alert('Email đã được đăng ký!');
                    return;
                }
                users.push({ email, password, name: email.split('@')[0] });
                localStorage.setItem('users', JSON.stringify(users));
                alert('Đăng ký thành công! Vui lòng đăng nhập.');
                $('#backToLogin a').click();
            } else {
                // Đăng nhập
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const user = users.find(u => u.email === email && u.password === password);
                if (user) {
                    currentUser = { email: user.email, name: user.name };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    updateAuthUI();
                    $('#authModal').modal('hide');
                    alert('Đăng nhập thành công!');
                } else {
                    alert('Email hoặc mật khẩu không đúng!');
                }
            }
        });

        // ====================== GIỎ HÀNG & THANH TOÁN ======================
        function addToCart(id) {
            const product = products.find(p => p.id === id);
            cart.push(product);
            saveCart();
            alert('Đã thêm ' + product.title + ' vào giỏ hàng!');
        }

        $('#cartBtn').click(function () {
            const cartItems = $('#cartItems');
            cartItems.empty();
            let total = 0;
            cart.forEach((item, index) => {
                const li = `<li class="list-group-item d-flex justify-content-between align-items-center">
                    ${item.title} - ${item.price.toLocaleString()} VND
                    <button class="btn btn-sm btn-danger remove-item" data-index="${index}">Xóa</button>
                </li>`;
                cartItems.append(li);
                total += item.price;
            });
            $('#totalPrice').text(total.toLocaleString());

            // Nút thanh toán
            $('.modal-footer .btn-primary').off().text(currentUser ? 'Thanh Toán' : 'Đăng nhập để thanh toán')
                .attr('id', currentUser ? '' : 'loginToCheckout');

            $('#cartModal').modal('show');
        });

        // Xóa sản phẩm khỏi giỏ
        $(document).on('click', '.remove-item', function () {
            const index = $(this).data('index');
            cart.splice(index, 1);
            saveCart();
            $('#cartBtn').click(); // refresh modal
        });

        // Nút thanh toán trong giỏ hàng
        $(document).on('click', '.modal-footer .btn-primary', function () {
            if (!currentUser) {
                $('#cartModal').modal('hide');
                $('#authModal').modal('show');
                return;
            }
            if (cart.length === 0) {
                alert('Giỏ hàng trống!');
                return;
            }
            // Mở modal thanh toán
            $('#checkoutItems').empty();
            let total = 0;
            cart.forEach(item => {
                $('#checkoutItems').append(`<li class="list-group-item">${item.title} - ${item.price.toLocaleString()} VND</li>`);
                total += item.price;
            });
            $('#checkoutTotal').text(total.toLocaleString());
            $('#checkoutModal').modal('show');
            $('#cartModal').modal('hide');
        });

        // Hiển thị thông tin chuyển khoản
        $('input[name="paymentMethod"]').change(function () {
            $('#bankInfo').toggle(this.value === 'bank');
        });

        // Xác nhận đơn hàng
        $('#confirmCheckout').click(function () {
            if (!$('#checkoutName').val() || !$('#checkoutPhone').val() || !$('#checkoutAddress').val()) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }

            const method = $('input[name="paymentMethod"]:checked').val();
            alert(`Cảm ơn ${currentUser.name}!\nĐơn hàng đã được đặt thành công.\nPhương thức: ${method === 'cod' ? 'Thanh toán khi nhận hàng' : 'Chuyển khoản ngân hàng'}\nTổng tiền: ${$('#checkoutTotal').text()} VND`);

            // Xóa giỏ hàng sau khi đặt thành công
            cart = [];
            saveCart();
            $('#checkoutModal').modal('hide');
        });

        // Các hàm cũ: displayProducts, phân trang, lọc, modal chi tiết... (giữ nguyên như code gốc của bạn)
        // ... (copy toàn bộ JS hiển thị sản phẩm từ code cũ vào đây)

        // Khởi tạo
        $(document).ready(function () {
            updateAuthUI();
            updateCartCount();
            displayProducts(currentPage, currentCategory);
            $('.filter-btn[data-category="all"]').addClass('active');
        });
    </script>
</body>

</html>
